{"library_version": "8.11.2", "change_type": "Bug Fixes", "change_id": "LUCENE-10564", "change_description": ": Make sure SparseFixedBitSet#or updates ramBytesUsed.", "change_title": "SparseFixedBitSet#or doesn't update memory accounting", "detail_type": "Bug", "detail_affect_versions": "None", "detail_fix_versions": "8.11.2,9.2", "detail_description": "While debugging why a cache was using way more memory than expected, one of my colleagues noticed that SparseFixedBitSet#or doesn't update ramBytesUsed. Here's a unit test that demonstrates this: It also looks like we don't have any tests for SparseFixedBitSet memory accounting (unless I've missed them!) It'd be nice to add more coverage there too.", "patch_link": "none", "patch_content": "none"}
{"library_version": "8.11.2", "change_type": "Bug Fixes", "change_id": "LUCENE-10477", "change_description": ": Highlighter: WeightedSpanTermExtractor.extractWeightedSpanTerms to Query#rewrite\nmultiple times if necessary.", "change_title": "SpanBoostQuery.rewrite was incomplete for boost==1 factor", "detail_type": "Bug", "detail_affect_versions": "8.11.1", "detail_fix_versions": "10.0(main),8.11.2,9.2", "detail_description": "(This bug report concerns pre-9.0 code only but it's so subtle that it warrants sharing I think and maybe fixing if there was to be a 8.11.2 release in future.) Some existing code e.g. https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.11.1/lucene/queryparser/src/java/org/apache/lucene/queryparser/xml/builders/SpanNearBuilder.java#L54 adds a SpanBoostQuery even if there is no boost or the boost factor is 1.0 i.e. technically wrapping is unnecessary. Query rewriting should counteract this somewhat except it might not e.g. note at https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.11.1/lucene/core/src/java/org/apache/lucene/search/spans/SpanBoostQuery.java#L81-L83 how the rewrite is a no-op i.e. this.query.rewrite is not called! This can then manifest in strange ways e.g. during highlighting: This stacktrace is not from 8.11.1 code but the general logic is that at line 293 rewrite was called (except it didn't a full rewrite because of SpanBoostQuery wrapping around the SpanNearQuery) and so then at line 295 the IllegalArgumentException(\"Rewrite first!\") arises: https://github.com/apache/lucene-solr/blob/releases/lucene-solr/8.11.1/lucene/core/src/java/org/apache/lucene/search/spans/SpanMultiTermQueryWrapper.java#L101", "patch_link": "none", "patch_content": "none"}
{"library_version": "8.11.2", "change_type": "Optimizations", "change_id": "LUCENE-10481", "change_description": ": FacetsCollector will not request scores if it does not use them.", "change_title": "FacetsCollector does not need scores when not keeping them", "detail_type": "Improvement", "detail_affect_versions": "None", "detail_fix_versions": "8.11.2,9.2", "detail_description": "FacetsCollector currently always specifies ScoreMode.COMPLETE, we could get better performance by not requesting scores when we don't need them.", "patch_link": "none", "patch_content": "none"}
