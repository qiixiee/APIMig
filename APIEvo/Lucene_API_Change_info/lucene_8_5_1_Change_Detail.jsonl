{"library_version": "8.5.1", "change_type": "Bug Fixes", "change_id": "LUCENE-9300", "change_description": ": Fix corruption of the new gen field infos when doc values updates are applied on a segment created\nexternally and added to the index with IndexWriter#addIndexes(Directory).", "change_title": "Index corruption with doc values updates and addIndexes", "detail_type": "Bug", "detail_affect_versions": "None", "detail_fix_versions": "9.0,7.7.3,8.6,8.5.1", "detail_description": "Today a doc values update creates a new field infos file that contains the original field infos updated for the new generation as well as the new fields created by the doc values update. However existing fields are cloned through the global fields (shared in the index writer) instead of the local ones (present in the segment). In practice this is not an issue since field numbers are shared between segments created by the same index writer. But this assumption doesn't hold for segments created by different writers and added through IndexWriter#addIndexes(Directory). In this case, the field number of the same field can differ between segments so any doc values update can corrupt the index by assigning the wrong field number to an existing field in the next generation. When this happens, queries and merges can access wrong fields without throwing any error, leading to a silent corruption in the index.  Since segments are not guaranteed to have the same field number consistently we should ensure that doc values update preserves the segment's field number when rewriting field infos.", "patch_link": "none", "patch_content": "none"}
